<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Input Anggota â€” FastAPI</title>
  <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>ğŸ§¾ Input Anggota</h1>

    <div style="margin-bottom:15px;">
      <a href="/dashboard"><button class="home-btn">ğŸ  Kembali ke Dashboard</button></a>
    </div>

    <div style="text-align: right; margin: 10px 0;">
      <a href="/download_csv"><button class="download-csv">ğŸ’¾ Unduh CSV</button></a>
    </div>

    <!-- ğŸ§¾ Input Form -->
    <form action="/add" method="post" class="add-form" id="addForm">
      <input id="nikInput" name="content" type="text" placeholder="Input NIK anggota" required />
      <button type="submit">Tambah</button>
    </form>

    <!-- ğŸ“· Tombol scan QR -->
    <div style="text-align:center; margin-bottom:20px;">
      <button id="scanBtn" class="scan-btn">ğŸ“· Scan QR Anggota</button>
    </div>

    <!-- ğŸ“¸ Area kamera QR -->
    <div id="qrScanner" style="width:100%; display:none; margin-top:10px;">
      <div id="reader" style="width:100%;"></div>
      <button id="stopScanBtn" class="cancel-scan-btn">âŒ Tutup Scanner</button>
    </div>

    <!-- ğŸ“‹ Daftar anggota -->
    <div id="notes" class="notes">
      {% for note in notes %}
      <div class="note" data-note-id="{{ note.id }}">
        <p>{{ note.content }}</p>
        <small style="color: gray; font-size: 0.8em;">ğŸ•’ {{ note.created_local }}</small>

        <div class="actions">
          <form action="/delete/{{ note.id }}" method="post" style="display:inline;">
            <button type="submit" class="delete">âŒ</button>
          </form>
          <button type="button" class="edit" data-content="{{ note.content | e }}"
            onclick="showEditForm({{ note.id }}, this.dataset.content)">âœï¸</button>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- âœï¸ Edit Form -->
    <div id="editForm" class="edit-form" style="display:none;">
      <h3>Edit NIK Anggota</h3>
      <form id="editFormInner" method="post">
        <input type="hidden" id="editId" name="id" />
        <input type="text" id="editContent" name="content" required />
        <div style="margin-top:10px;">
          <button type="submit">Simpan</button>
          <button type="button" id="cancelEditBtn">Batal</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // === QR SCANNER SETUP ===
    const scanBtn = document.getElementById("scanBtn");
    const qrScanner = document.getElementById("qrScanner");
    const reader = document.getElementById("reader");
    const nikInput = document.getElementById("nikInput");
    const stopScanBtn = document.getElementById("stopScanBtn");
    let html5QrCode;

    scanBtn.addEventListener("click", () => {
      qrScanner.style.display = "block";
      html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          const camId = devices[0].id;
          html5QrCode.start(
            camId,
            { fps: 10, qrbox: 250 },
            decodedText => {
              nikInput.value = decodedText;
              html5QrCode.stop();
              qrScanner.style.display = "none";
            },
            errorMsg => { console.log("QR scanning...", errorMsg); }
          );
        }
      });
    });

    stopScanBtn.addEventListener("click", () => {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          qrScanner.style.display = "none";
        });
      }
    });

    // === EDIT / SEARCH / THEME ===
    function showEditForm(id, content) {
      document.getElementById("editForm").style.display = "block";
      document.getElementById("editId").value = id;
      document.getElementById("editContent").value = content;
    }

    document.getElementById("editFormInner").onsubmit = function (e) {
      e.preventDefault();
      let id = document.getElementById("editId").value;
      let content = document.getElementById("editContent").value;
      fetch(`/edit/${id}`, {
        method: "POST",
        body: new URLSearchParams({ content })
      }).then(() => window.location.reload());
    };

    document.getElementById("cancelEditBtn").addEventListener("click", () => {
      document.getElementById("editForm").style.display = "none";
    });

    const toggleBtn = document.getElementById("toggleTheme");
    if (toggleBtn) {
      const current = localStorage.getItem("theme");
      if (current === "dark") document.body.classList.add("dark"), toggleBtn.textContent = "â˜€ï¸";
      toggleBtn.addEventListener("click", () => {
        const isDark = document.body.classList.toggle("dark");
        toggleBtn.textContent = isDark ? "â˜€ï¸" : "ğŸŒ™";
        localStorage.setItem("theme", isDark ? "dark" : "light");
      });
    }
  </script>
</body>
</html>
